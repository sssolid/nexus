# ✅ VCDB INGESTION & MODEL PIPELINE (UPDATED CANONICAL PLAYBOOK)

This is the **single source of truth** going forward.

---

## 0️⃣ Hard reset (DEV ONLY – nuclear option)

### Drop VCDB canonical + raw data

```bash
docker compose exec web psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 <<'SQL'
DROP SCHEMA IF EXISTS autocare_vcdb CASCADE;
DROP TABLE IF EXISTS autocare_autocarerawrecord CASCADE;
SQL
```

Recreate schemas/tables via migrations afterward.

---

## 1️⃣ Run full VCDB baseline ingest (RAW DATA ONLY)

> **This replaces all manual ingest_autocare calls.**
> This is now the *only* supported way to build raw VCDB data.

### Fresh baseline (no resume)

```bash
docker compose exec web python manage.py vcdb_baseline_ingest
```

### Resume after failure

```bash
docker compose exec web python manage.py vcdb_baseline_ingest --resume
```

**Behavior**

* Uses `AsOfDate = 2025-12-18`
* Skips `/vcdb/equipment/*`
* Skips `/vcdb/VCdbChanges`
* Retries per endpoint
* Resumes per page when requested
* Hard-fails if retries are exhausted

---

## 2️⃣ Backup raw VCDB payloads (recommended)

```bash
docker compose exec db pg_dump \
  -U postgres \
  -Fc \
  -t autocare_autocarerawrecord \
  nexus \
  > data/autocare/raw/vcdb_raw_$(date +%F).dump
```

### Restore raw payloads if needed

```bash
cat data/autocare/raw/vcdb_raw_2025-12-22.dump | \
docker compose exec -T db pg_restore \
  -U postgres \
  -d nexus \
  --clean \
  --if-exists
```

---

## 3️⃣ Create staging schema (for model generation only)

```bash
docker compose exec web bash -c '
set -e
export PGPASSWORD=postgres

psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS staging_vcdb CASCADE; CREATE SCHEMA staging_vcdb;"
psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 -c "SET search_path TO staging_vcdb;" -f /app/src/data/autocare/db_schema/vcdb_schema.sql
python manage.py generate_autocare_models --schema staging_vcdb --output-dir apps/autocare/models/_staging_dump/vcdb

psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS staging_pcdb CASCADE; CREATE SCHEMA staging_pcdb;"
psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 -c "SET search_path TO staging_pcdb;" -f /app/src/data/autocare/db_schema/pcdb_schema.sql
python manage.py generate_autocare_models --schema staging_pcdb --output-dir apps/autocare/models/_staging_dump/pcdb

psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS staging_padb CASCADE; CREATE SCHEMA staging_padb;"
psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 -c "SET search_path TO staging_padb;" -f /app/src/data/autocare/db_schema/padb_schema.sql
python manage.py generate_autocare_models --schema staging_padb --output-dir apps/autocare/models/_staging_dump/padb

psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS staging_qdb CASCADE; CREATE SCHEMA staging_qdb;"
psql -h db -U postgres -d nexus -v ON_ERROR_STOP=1 -c "SET search_path TO staging_qdb;"  -f /app/src/data/autocare/db_schema/qdb_schema.sql
python manage.py generate_autocare_models --schema staging_qdb  --output-dir apps/autocare/models/_staging_dump/qdb
'
```


⚠️ **Reminder**
The SQL schema **must**:

* quote table names
* quote column names
* preserve exact VCDB casing

---

## 4️⃣ Generate Django models (AUTOGENERATED, NOT FINAL)

```bash
docker compose exec web python manage.py generate_autocare_models
```

### Mandatory manual fixes (until generator is fixed)

You already identified these correctly — this list is now **official**:

* **File naming**

  * `v_cdb_changes.py` → `vcdb_changes.py`
* **Reserved fields**

  * Rename `id` → `<model>_id`
* **ForeignKey collisions**

  * `class_` → `vehicle_class`
* **CamelCase normalization**

  * Generator must map:

    * `SubModelID` → `submodel_id`
    * `VehicleTypeID` → `vehicle_type_id`
* **Self-FKs**

  * Explicit `related_name`

⚠️ Do **not** proceed until these are clean.

---

## 5️⃣ Validate models (hard gate)

```bash
docker compose exec web python manage.py validate_autocare_models
```

If this fails: **stop**.
Fix models. Re-run validation.

---

## 6️⃣ Create canonical schema via migrations

```bash
docker compose exec web python manage.py makemigrations autocare
docker compose exec web python manage.py migrate autocare
```

At this point:

* `autocare_vcdb.*` tables exist
* FK constraints are enforced
* Schema is stable

---

## 7️⃣ Ingest raw → canonical VCDB tables

### Automatic dependency-aware ingest

```bash
docker compose exec web python manage.py ingest_vcdb_payloads --skip-missing-vehicles --skip-missing-engineconfig2
# docker compose exec web python manage.py ingest_vcdb_payloads --db vcdb --order auto_fk
```

### Resume canonical ingest after failure

```bash
docker compose exec web python manage.py ingest_vcdb_payloads --skip-missing-vehicles --skip-missing-engineconfig2 --resume
# docker compose exec web python manage.py ingest_vcdb_payloads --db vcdb --order auto_fk --resume
```

**Features**

* Topological FK ordering
* Batch inserts
* Detailed FK violation logging
* Resume support
* Hard exit on irrecoverable integrity errors

---

## 8️⃣ Post-ingest verification (recommended)

```sql
-- Orphans check example
SELECT COUNT(*)
FROM autocare_vcdb.vehicle_to_engine_config vtec
LEFT JOIN autocare_vcdb.vehicle v ON v.vehicle_id = vtec.vehicle_id
WHERE v.vehicle_id IS NULL;
```

Should return **0**.

---

## TODO

### Generator hardening

Fix CamelCase normalization and reserved-name handling once, centrally.

### Baseline lock

Prevent concurrent baseline runs (simple DB lock row).

### FK readiness checks

Preflight before canonical ingest to fail faster.

### Celery wiring

Wrap baseline and canonical ingest as chained tasks.

### Other improvements

#### Incremental updates (SinceDate nightly jobs)

#### ACES / PIES ingestion and normalization

#### Search/indexing strategy (Postgres, OpenSearch, etc.)

#### Admin/UI for VCDB exploration

#### Data validation & diffing against previous baselines

#### Media sees VCDB join work (fitment → products)